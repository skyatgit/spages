# SPages V3 æ¶æ„é‡æ„å®Œæˆ

## ğŸ‰ é‡æ„å†…å®¹

å·²å°†é¡¹ç›®æ¶æ„ä»åˆ†æ•£å¼å­˜å‚¨é‡æ„ä¸º**é¡¹ç›®ä¸ºä¸­å¿ƒ**çš„ç›®å½•ç»“æ„ï¼Œæ‰€æœ‰é¡¹ç›®ç›¸å…³æ•°æ®ç°åœ¨éƒ½å­˜å‚¨åœ¨é¡¹ç›®è‡ªå·±çš„æ–‡ä»¶å¤¹ä¸­ã€‚

## ğŸ“ æ–°çš„ç›®å½•ç»“æ„

```
projects/
â”œâ”€â”€ avatar_generator/              # é¡¹ç›®æ–‡ä»¶å¤¹
â”‚   â”œâ”€â”€ .spages/                  # SPages å…ƒæ•°æ®ç›®å½•
â”‚   â”‚   â”œâ”€â”€ config.json           # é¡¹ç›®é…ç½®
â”‚   â”‚   â”œâ”€â”€ deployments.json      # éƒ¨ç½²å†å²
â”‚   â”‚   â”œâ”€â”€ env.json              # ç¯å¢ƒå˜é‡
â”‚   â”‚   â””â”€â”€ logs/                 # éƒ¨ç½²æ—¥å¿—
â”‚   â”‚       â”œâ”€â”€ deploy_xxx.log
â”‚   â”‚       â””â”€â”€ deploy_yyy.log
â”‚   â””â”€â”€ source/                   # æºç ç›®å½•
â”‚       â”œâ”€â”€ src/
â”‚       â”œâ”€â”€ package.json
â”‚       â”œâ”€â”€ node_modules/
â”‚       â””â”€â”€ dist/
â”‚
data/
â”œâ”€â”€ config.json                   # å…¨å±€é…ç½®
â”œâ”€â”€ github-accounts.json          # GitHub è´¦å·
â””â”€â”€ projects-index.json           # é¡¹ç›®ç´¢å¼•ï¼ˆå¿«é€ŸæŸ¥è¯¢ï¼‰
```

## âœ¨ æ–°åŠŸèƒ½

### 1. **çœŸå®çš„éƒ¨ç½²å†å²**
- æ¯æ¬¡éƒ¨ç½²éƒ½ä¼šè®°å½•åˆ° `deployments.json`
- åŒ…å«çŠ¶æ€ã€æ—¶é—´æˆ³ã€commitã€è€—æ—¶ç­‰ä¿¡æ¯
- å¯ä»¥æŸ¥çœ‹å†å²éƒ¨ç½²çš„æ—¥å¿—

### 2. **ç¯å¢ƒå˜é‡ç®¡ç†**
- æ¯ä¸ªé¡¹ç›®ç‹¬ç«‹çš„ç¯å¢ƒå˜é‡é…ç½®
- æ”¯æŒæ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤
- çœŸå®ä¿å­˜åˆ° `env.json` æ–‡ä»¶

### 3. **é¡¹ç›®ç´¢å¼•ç³»ç»Ÿ**
- å¿«é€ŸæŸ¥è¯¢æ‰€æœ‰é¡¹ç›®ï¼ˆä¸éœ€è¦æ‰«æç›®å½•ï¼‰
- æ¯30ç§’è‡ªåŠ¨åŒæ­¥ç´¢å¼•
- æ”¯æŒæ‰‹åŠ¨æ“ä½œæ–‡ä»¶ç³»ç»Ÿåè‡ªåŠ¨æ¢å¤

### 4. **å®Œæ•´çš„é¡¹ç›®éš”ç¦»**
- æ¯ä¸ªé¡¹ç›®çš„æ‰€æœ‰æ•°æ®éƒ½åœ¨è‡ªå·±çš„æ–‡ä»¶å¤¹ä¸­
- åˆ é™¤é¡¹ç›® = åˆ é™¤æ•´ä¸ªæ–‡ä»¶å¤¹
- ä¾¿äºå¤‡ä»½å’Œè¿ç§»

## ğŸ”§ å¦‚ä½•è¿ç§»ç°æœ‰é¡¹ç›®

### æ­¥éª¤ 1: è¿è¡Œè¿ç§»è„šæœ¬

```bash
node scripts/migrate-to-v3.js
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- âœ… åˆ›å»ºæ–°çš„ç›®å½•ç»“æ„ (`.spages/`, `source/`)
- âœ… ç§»åŠ¨æºç åˆ° `source/` ç›®å½•
- âœ… åˆ›å»ºé…ç½®æ–‡ä»¶ (`config.json`, `deployments.json`, `env.json`)
- âœ… è¿ç§»æ—¥å¿—æ–‡ä»¶åˆ°é¡¹ç›®ç›®å½•
- âœ… ç”Ÿæˆé¡¹ç›®ç´¢å¼• (`projects-index.json`)
- âœ… å¤‡ä»½æ—§çš„ `projects.json`

### æ­¥éª¤ 2: éªŒè¯è¿ç§»ç»“æœ

æ£€æŸ¥ `projects/` ç›®å½•ï¼Œç¡®ä¿æ¯ä¸ªé¡¹ç›®éƒ½æœ‰ï¼š
- `.spages/` ç›®å½•
- `source/` ç›®å½•ï¼ˆåŒ…å«æºç ï¼‰

### æ­¥éª¤ 3: é‡å¯æœåŠ¡å™¨

```bash
npm run dev
```

æœåŠ¡å™¨ä¼šè‡ªåŠ¨ï¼š
- ä½¿ç”¨æ–°çš„ V3 API
- å¯åŠ¨é¡¹ç›®ç´¢å¼•åŒæ­¥
- æ¯30ç§’åŒæ­¥ä¸€æ¬¡é¡¹ç›®çŠ¶æ€

### æ­¥éª¤ 4: æµ‹è¯•åŠŸèƒ½

1. **é¡¹ç›®åˆ—è¡¨** - åº”è¯¥èƒ½çœ‹åˆ°æ‰€æœ‰è¿ç§»çš„é¡¹ç›®
2. **é¡¹ç›®è¯¦æƒ…** - ç‚¹å‡»é¡¹ç›®å¡ç‰‡æŸ¥çœ‹è¯¦æƒ…
3. **éƒ¨ç½²å†å²** - æŸ¥çœ‹å†å²éƒ¨ç½²è®°å½•
4. **æ—¥å¿—æŸ¥çœ‹** - æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—
5. **ç¯å¢ƒå˜é‡** - æ·»åŠ /ç¼–è¾‘ç¯å¢ƒå˜é‡

### æ­¥éª¤ 5: æ¸…ç†æ—§æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œå¯ä»¥åˆ é™¤ï¼š
```bash
rm data/projects.json.backup
rm -rf data/logs  # æ—§æ—¥å¿—å·²å¤åˆ¶åˆ°å„é¡¹ç›®
```

## ğŸ“Š æ–°æ—§å¯¹æ¯”

### æ—§ç»“æ„ï¼ˆV2ï¼‰
```
âŒ data/projects.json       # æ‰€æœ‰é¡¹ç›®é…ç½®æ··åœ¨ä¸€èµ·
âŒ data/logs/*.log          # æ‰€æœ‰æ—¥å¿—æ··åœ¨ä¸€èµ·
âŒ projects/{name}/         # ç›´æ¥æ˜¯æºç 
âŒ æ²¡æœ‰éƒ¨ç½²å†å²
âŒ æ²¡æœ‰ç¯å¢ƒå˜é‡ç®¡ç†
```

### æ–°ç»“æ„ï¼ˆV3ï¼‰
```
âœ… projects/{name}/.spages/config.json       # é¡¹ç›®ç‹¬ç«‹é…ç½®
âœ… projects/{name}/.spages/logs/*.log        # é¡¹ç›®ç‹¬ç«‹æ—¥å¿—
âœ… projects/{name}/.spages/deployments.json  # å®Œæ•´éƒ¨ç½²å†å²
âœ… projects/{name}/.spages/env.json          # ç¯å¢ƒå˜é‡
âœ… projects/{name}/source/                   # æºç éš”ç¦»
âœ… data/projects-index.json                  # å¿«é€Ÿç´¢å¼•
```

## ğŸ¯ ä¼˜åŠ¿

1. **æ›´æ¸…æ™°çš„ç»„ç»‡** - ä¸€ä¸ªé¡¹ç›®çš„æ‰€æœ‰ä¸œè¥¿éƒ½åœ¨ä¸€èµ·
2. **æ›´å®¹æ˜“ç®¡ç†** - åˆ é™¤é¡¹ç›® = åˆ é™¤æ–‡ä»¶å¤¹
3. **æ›´å¥½çš„éš”ç¦»** - é¡¹ç›®ä¹‹é—´äº’ä¸å½±å“
4. **æ›´æ˜“å¤‡ä»½** - æ¯ä¸ªé¡¹ç›®ç‹¬ç«‹å¤‡ä»½
5. **æ€§èƒ½æ›´å¥½** - ç´¢å¼•ç³»ç»ŸåŠ é€ŸæŸ¥è¯¢
6. **åŠŸèƒ½æ›´å®Œæ•´** - éƒ¨ç½²å†å² + ç¯å¢ƒå˜é‡

## ğŸ“ API å˜åŒ–

### æ–°å¢ API

```javascript
GET  /api/projects/:id/deployments      // è·å–éƒ¨ç½²å†å²
GET  /api/projects/:id/logs?deploymentId=xxx  // è·å–ç‰¹å®šéƒ¨ç½²çš„æ—¥å¿—
GET  /api/projects/:id/env              // è·å–ç¯å¢ƒå˜é‡
PUT  /api/projects/:id/env              // æ›´æ–°ç¯å¢ƒå˜é‡
```

### å‰ç«¯ API è°ƒç”¨

```javascript
import {
  getDeploymentHistory,
  getEnvVars,
  updateEnvVars
} from '@/api/projects'

// è·å–éƒ¨ç½²å†å²
const history = await getDeploymentHistory(projectId)

// è·å–ç¯å¢ƒå˜é‡
const envVars = await getEnvVars(projectId)

// æ›´æ–°ç¯å¢ƒå˜é‡
await updateEnvVars(projectId, { API_URL: 'https://...', SECRET: '...' })

// è·å–ç‰¹å®šéƒ¨ç½²çš„æ—¥å¿—
const logs = await getProjectLogs(projectId, deploymentId)
```

## ğŸ” æ–‡ä»¶è¯´æ˜

### æ–°å¢æ–‡ä»¶

- `server/services/project-manager.js` - é¡¹ç›®ç›®å½•å’Œç´¢å¼•ç®¡ç†
- `server/services/deployment-v3.js` - æ–°çš„éƒ¨ç½²æœåŠ¡
- `server/routes/projects-v3.js` - æ–°çš„è·¯ç”±å¤„ç†
- `scripts/migrate-to-v3.js` - è¿ç§»è„šæœ¬

### ä¿®æ”¹æ–‡ä»¶

- `server/index.js` - å¯åŠ¨ç´¢å¼•åŒæ­¥
- `src/api/projects.js` - æ–°å¢ API æ–¹æ³•
- `src/views/ProjectDetail.vue` - ä½¿ç”¨çœŸå®æ•°æ®
- `src/components/ProjectCard.vue` - ä¿®å¤ç‚¹å‡»äº‹ä»¶

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½æ•°æ®** - è¿ç§»å‰å»ºè®®å¤‡ä»½ `data/` å’Œ `projects/` ç›®å½•
2. **åœæ­¢æœåŠ¡** - è¿ç§»æ—¶è¯·å…ˆåœæ­¢æœåŠ¡å™¨
3. **æ£€æŸ¥æƒé™** - ç¡®ä¿æœ‰æ–‡ä»¶ç³»ç»Ÿè¯»å†™æƒé™
4. **Node ç‰ˆæœ¬** - éœ€è¦ Node.js 18+ æ”¯æŒ

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ï¼šè¿ç§»åçœ‹ä¸åˆ°é¡¹ç›®

**è§£å†³**ï¼šæ‰‹åŠ¨è§¦å‘ç´¢å¼•åŒæ­¥
```javascript
// åœ¨æœåŠ¡å™¨æ§åˆ¶å°è¿è¡Œ
projectIndex.sync()
```

### é—®é¢˜ï¼šæ—¥å¿—æ˜¾ç¤ºç©ºç™½

**æ£€æŸ¥**ï¼š
1. `.spages/logs/` ç›®å½•æ˜¯å¦å­˜åœ¨
2. æ—¥å¿—æ–‡ä»¶æ˜¯å¦æœ‰è¯»å–æƒé™
3. `deployments.json` æ˜¯å¦æ­£ç¡®

### é—®é¢˜ï¼šç¯å¢ƒå˜é‡ä¸ä¿å­˜

**æ£€æŸ¥**ï¼š
1. `.spages/env.json` æ˜¯å¦å­˜åœ¨
2. æ˜¯å¦æœ‰å†™å…¥æƒé™
3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æœåŠ¡å™¨æ§åˆ¶å°æ—¥å¿—
2. æµè§ˆå™¨æ§åˆ¶å°
3. `data/projects-index.json` æ˜¯å¦æ­£ç¡®ç”Ÿæˆ

## ğŸŠ å®Œæˆï¼

ç°åœ¨ä½ æ‹¥æœ‰ä¸€ä¸ªæ›´åŠ å¼ºå¤§ã€æ¸…æ™°ã€æ˜“ç®¡ç†çš„ SPages ç³»ç»Ÿï¼
