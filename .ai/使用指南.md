# SPages ç³»ç»Ÿå‰ç«¯æ‰˜ç®¡ä½¿ç”¨æŒ‡å—

## ğŸ¯ æ”¹é€ æ¦‚è¿°

SPages å‰ç«¯ç°å·²ä½œä¸ºç³»ç»Ÿçº§å—ç®¡é¡¹ç›®ï¼Œæ”¯æŒ dev/prod åŒæ¨¡å¼è¿è¡Œï¼Œä¸å…¶ä»– GitHub é¡¹ç›®ç»Ÿä¸€ç®¡ç†ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å¼€å‘ç¯å¢ƒ
```bash
cd C:\Users\12189\WebstormProjects\spages
npm start
```

åç«¯å°†ï¼š
- ç›‘å¬ `localhost:3000`ï¼ˆä»…æœ¬åœ°è®¿é—®ï¼‰
- è‡ªåŠ¨åˆ›å»ºç³»ç»Ÿå‰ç«¯é¡¹ç›®é…ç½®
- **è‡ªåŠ¨å¯åŠ¨ç³»ç»Ÿå‰ç«¯**ï¼ˆdev æ¨¡å¼ï¼Œç«¯å£ 5173ï¼‰

### ç”Ÿäº§ç¯å¢ƒ
```bash
cd C:\Users\12189\WebstormProjects\spages
npm run start:prod
```

åç«¯å°†ï¼š
- ç›‘å¬ `localhost:3000`
- **è‡ªåŠ¨æ„å»ºå‰ç«¯**ï¼ˆå¦‚æœéœ€è¦ï¼‰
- è‡ªåŠ¨å¯åŠ¨ç³»ç»Ÿå‰ç«¯ï¼ˆprod æ¨¡å¼ï¼Œé™æ€æ‰˜ç®¡ dist/ï¼‰

### è®¿é—®åº”ç”¨
- **å‰ç«¯ç•Œé¢**ï¼š`http://localhost:5173` (æˆ–æ˜¾ç¤ºçš„å…¶ä»–ç«¯å£)
- **åç«¯ API**ï¼š`http://localhost:3000/api/health` (ä»…æµ‹è¯•ç”¨)

**æ³¨æ„**ï¼š
- å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒéƒ½åªéœ€ä¸€ä¸ªå‘½ä»¤
- åç«¯ä¼šè‡ªåŠ¨å¤„ç†å‰ç«¯çš„æ„å»ºã€å¯åŠ¨å’Œæ‰˜ç®¡
- æ— éœ€æ‰‹åŠ¨è¿è¡Œä»»ä½•å‰ç«¯å‘½ä»¤

## ğŸ”§ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æµè§ˆå™¨ (Browser)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        å‰ç«¯æœåŠ¡ (Frontend Service)              â”‚
â”‚  â€¢ Dev æ¨¡å¼: Vite Dev Server (çƒ­æ›´æ–°)          â”‚
â”‚  â€¢ Prod æ¨¡å¼: é™æ€æ–‡ä»¶æœåŠ¡å™¨ (dist/)            â”‚
â”‚  ç›‘å¬: 0.0.0.0:5173                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ API è¯·æ±‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          åç«¯ API (Backend API)                 â”‚
â”‚  Express æœåŠ¡å™¨                                 â”‚
â”‚  ç›‘å¬: localhost:3000 (ä»…æœ¬åœ°)                  â”‚
â”‚  åŠŸèƒ½: é¡¹ç›®ç®¡ç†ã€éƒ¨ç½²ã€GitHub é›†æˆ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ å…³é”®æ–‡ä»¶å’Œé…ç½®

### 1. ä¸»é…ç½®æ–‡ä»¶
**ä½ç½®**ï¼š`data/config.json`

```json
{
  "frontend": {
    "projectId": "proj_spages_frontend",
    "defaultMode": "dev",
    "defaultPort": 5173,
    "autoRestart": true
  }
}
```

### 2. é¡¹ç›®ç´¢å¼•
**ä½ç½®**ï¼š`data/projects-index.json`

```json
{
  "proj_spages_frontend": {
    "name": "spages-frontend",
    "port": 5173,
    "status": "running",
    "type": "core",
    "managed": true,
    "mode": "dev",
    "url": "http://192.168.1.27:5173"
  }
}
```

### 3. é¡¹ç›®é…ç½®
**ä½ç½®**ï¼š`projects/spages-frontend/.spages/config.json`

```json
{
  "id": "proj_spages_frontend",
  "name": "spages-frontend",
  "port": 5173,
  "sourceRoot": ".",          // ä½¿ç”¨ä»“åº“æ ¹ç›®å½•ä½œä¸ºæºç è·¯å¾„
  "mode": "dev",
  "type": "core",
  "managed": true,
  "buildCommand": "npm run build",
  "outputDir": "dist"
}
```

**å…³é”®å­—æ®µè¯´æ˜**ï¼š
- `sourceRoot: "."`ï¼šç³»ç»Ÿå‰ç«¯é¡¹ç›®ä½¿ç”¨å½“å‰ä»“åº“æ ¹ç›®å½•ä½œä¸ºæºç ï¼Œè€Œä¸æ˜¯ `projects/spages-frontend/source`
- `type: "core"`ï¼šæ ‡è®°ä¸ºæ ¸å¿ƒç³»ç»Ÿé¡¹ç›®
- `managed: true`ï¼šå—ç³»ç»Ÿç»Ÿä¸€ç®¡ç†

## ğŸ® è¿è¡Œæ¨¡å¼

### Dev æ¨¡å¼ï¼ˆå¼€å‘ï¼‰
**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ Vite Dev Server
- æ”¯æŒçƒ­æ¨¡å—æ›¿æ¢ï¼ˆHMRï¼‰
- å®æ—¶ç¼–è¯‘
- æºç æ˜ å°„å®Œæ•´

**å¯åŠ¨**ï¼š
```bash
npm run dev
```

æˆ–é€šè¿‡ APIï¼š
```bash
POST /api/projects/proj_spages_frontend/mode
{
  "mode": "dev"
}
```

### Prod æ¨¡å¼ï¼ˆç”Ÿäº§ï¼‰
**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨æ„å»ºåçš„é™æ€æ–‡ä»¶ï¼ˆ`dist/`ï¼‰
- ä¼˜åŒ–å’Œå‹ç¼©
- æ›´å¿«çš„åŠ è½½é€Ÿåº¦
- å†…ç½®é™æ€æ–‡ä»¶æœåŠ¡å™¨

**æµç¨‹**ï¼š
1. æ„å»ºï¼š`npm run build`
2. é€šè¿‡ API åˆ‡æ¢åˆ° prod æ¨¡å¼ï¼š
```bash
POST /api/projects/proj_spages_frontend/mode
{
  "mode": "prod"
}
```

## ğŸ”„ æ¨¡å¼åˆ‡æ¢

### é€šè¿‡ API
```bash
# åˆ‡æ¢åˆ°å¼€å‘æ¨¡å¼
POST http://localhost:3000/api/projects/proj_spages_frontend/mode
Content-Type: application/json
Authorization: Bearer <token>

{
  "mode": "dev"
}

# åˆ‡æ¢åˆ°ç”Ÿäº§æ¨¡å¼
POST http://localhost:3000/api/projects/proj_spages_frontend/mode
Content-Type: application/json
Authorization: Bearer <token>

{
  "mode": "prod"
}
```

### é€šè¿‡å‰ç«¯ UIï¼ˆæ¨èï¼‰
1. ç™»å½• SPages ç®¡ç†ç•Œé¢
2. åœ¨ Dashboard æ‰¾åˆ°"ç³»ç»Ÿå‰ç«¯"å¡ç‰‡
3. ç‚¹å‡»"åˆ‡æ¢ä¸º prod" æˆ– "åˆ‡æ¢ä¸º dev" æŒ‰é’®
4. ç­‰å¾…çŠ¶æ€å˜ä¸º "running"

## ğŸ“Š é¡¹ç›®ç®¡ç† API

### 1. è·å–é¡¹ç›®çŠ¶æ€
```bash
GET /api/projects/proj_spages_frontend
Authorization: Bearer <token>
```

å“åº”ï¼š
```json
{
  "id": "proj_spages_frontend",
  "name": "spages-frontend",
  "status": "running",
  "mode": "dev",
  "port": 5173,
  "url": "http://192.168.1.27:5173",
  "type": "core",
  "managed": true
}
```

### 2. å¯åŠ¨é¡¹ç›®
```bash
POST /api/projects/proj_spages_frontend/start
Authorization: Bearer <token>
```

### 3. åœæ­¢é¡¹ç›®
```bash
POST /api/projects/proj_spages_frontend/stop
Authorization: Bearer <token>
```

### 4. é‡å¯é¡¹ç›®ï¼ˆä¿æŒå½“å‰æ¨¡å¼ï¼‰
```bash
POST /api/projects/proj_spages_frontend/restart
Authorization: Bearer <token>
```

### 5. è·å–é¡¹ç›®åˆ—è¡¨
```bash
GET /api/projects
Authorization: Bearer <token>
```

ç³»ç»Ÿå‰ç«¯é¡¹ç›®ä¼šå‡ºç°åœ¨åˆ—è¡¨ä¸­ã€‚

## ğŸ” å®æ—¶çŠ¶æ€ç›‘æ§ï¼ˆSSEï¼‰

### è®¢é˜…é¡¹ç›®çŠ¶æ€æµ
```javascript
const token = localStorage.getItem('auth_token')
const eventSource = new EventSource(`/api/projects/proj_spages_frontend/state/stream?token=${token}`)

eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data)
  console.log('Project state update:', data)
  
  if (data.type === 'state') {
    console.log('Status:', data.data.status)
    console.log('Mode:', data.data.mode)
    console.log('Port:', data.data.port)
    console.log('URL:', data.data.url)
  }
}
```

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šå‰ç«¯æ— æ³•å¯åŠ¨
**ç°è±¡**ï¼šè®¿é—® `http://localhost:5173` è¿æ¥è¢«æ‹’ç»

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼š
```bash
netstat -ano | findstr ":5173"
```

2. æ£€æŸ¥é¡¹ç›®çŠ¶æ€ï¼š
```bash
GET /api/projects/proj_spages_frontend
```

3. æŸ¥çœ‹æ—¥å¿—ï¼š
```bash
GET /api/projects/proj_spages_frontend/logs
```

4. æ‰‹åŠ¨å¯åŠ¨ï¼š
```bash
npm run dev
```

### é—®é¢˜ 2ï¼šæ¨¡å¼åˆ‡æ¢å¤±è´¥
**ç°è±¡**ï¼šåˆ‡æ¢æ¨¡å¼åçŠ¶æ€æ˜¾ç¤º "failed"

**å¯èƒ½åŸå› **ï¼š
- Prod æ¨¡å¼ï¼š`dist/` ç›®å½•ä¸å­˜åœ¨ï¼ˆéœ€è¦å…ˆæ„å»ºï¼‰
- Dev æ¨¡å¼ï¼šç«¯å£è¢«å ç”¨æˆ–ä¾èµ–æœªå®‰è£…

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®ä¿ä¾èµ–å·²å®‰è£…ï¼š
```bash
npm install
```

2. Prod æ¨¡å¼å‰å…ˆæ„å»ºï¼š
```bash
npm run build
```

3. æ£€æŸ¥ç«¯å£å¯ç”¨æ€§

### é—®é¢˜ 3ï¼šAPI è¯·æ±‚å¤±è´¥
**ç°è±¡**ï¼šå‰ç«¯æ— æ³•è¿æ¥åç«¯ API

**æ£€æŸ¥**ï¼š
1. åç«¯æ˜¯å¦è¿è¡Œï¼š
```bash
netstat -ano | findstr ":3000"
```

2. Vite ä»£ç†é…ç½®ï¼ˆ`vite.config.js`ï¼‰ï¼š
```javascript
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:3000',
        changeOrigin: true
      }
    }
  }
})
```

### é—®é¢˜ 4ï¼šçƒ­æ›´æ–°ä¸å·¥ä½œ
**Dev æ¨¡å¼ç‰¹å®šé—®é¢˜**

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ Vite é…ç½®
2. æ¸…é™¤ç¼“å­˜ï¼š
```bash
rm -rf node_modules/.vite
npm run dev
```

3. æ£€æŸ¥æ–‡ä»¶ç›‘å¬å™¨ï¼š
```bash
# Linux/Mac
ulimit -n 4096

# Windowsï¼šé€šå¸¸ä¸éœ€è¦è°ƒæ•´
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### Dev æ¨¡å¼
- âœ… å·²å¯ç”¨ HMR
- âœ… æºç æ˜ å°„
- âœ… å¿«é€Ÿåˆ·æ–°

### Prod æ¨¡å¼
- âœ… ä»£ç å‹ç¼©
- âœ… Tree shaking
- âœ… èµ„æºä¼˜åŒ–
- âœ… ç¼“å­˜å¤´è®¾ç½®ï¼ˆé™æ€èµ„æº 1 å°æ—¶ï¼‰

## ğŸ” å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. åç«¯ä»… localhost è®¿é—®
åç«¯ API åªç›‘å¬ `localhost:3000`ï¼Œä¸å¯¹å¤–ç½‘æš´éœ²ã€‚

### 2. å‰ç«¯å¯¹å¤–æœåŠ¡
å‰ç«¯ç›‘å¬ `0.0.0.0:5173`ï¼Œå¯é€šè¿‡ç½‘ç»œè®¿é—®ã€‚

### 3. ç”Ÿäº§éƒ¨ç½²å»ºè®®
- ä½¿ç”¨ Nginx/Caddy ä½œä¸ºåå‘ä»£ç†
- é…ç½® HTTPS
- è®¾ç½®é˜²ç«å¢™è§„åˆ™
- ä½¿ç”¨ PM2 æˆ– systemd ç®¡ç†è¿›ç¨‹

## ğŸ¨ å‰ç«¯ UI é›†æˆ

### Dashboard ä¸­çš„ç³»ç»Ÿå‰ç«¯å¡ç‰‡
```vue
<div v-if="coreFrontend" class="core-frontend-actions">
  <div class="card">
    <h3>ç³»ç»Ÿå‰ç«¯</h3>
    <p>
      å½“å‰æ¨¡å¼ï¼š<strong>{{ coreFrontend.mode || 'dev' }}</strong>ï¼Œ
      ç«¯å£ï¼š<strong>{{ coreFrontend.port || '-' }}</strong>
    </p>
    <div class="actions">
      <button @click="switchCoreMode(coreFrontend.mode === 'dev' ? 'prod' : 'dev')">
        åˆ‡æ¢ä¸º {{ coreFrontend.mode === 'dev' ? 'prod' : 'dev' }}
      </button>
      <button @click="restartCore()">é‡å¯</button>
    </div>
  </div>
</div>
```

### ä½¿ç”¨æ–¹æ³•
1. åœ¨ `computed` ä¸­æŸ¥æ‰¾æ ¸å¿ƒå‰ç«¯é¡¹ç›®ï¼š
```javascript
const coreFrontend = computed(() => 
  projects.value.find(p => p.type === 'core' && p.managed === true)
)
```

2. è°ƒç”¨ APIï¼š
```javascript
async function switchCoreMode(target) {
  await projectsAPI.switchMode(coreFrontend.value.id, target)
  toast.success('æ¨¡å¼å·²åˆ‡æ¢')
}

async function restartCore() {
  await projectsAPI.restartProject(coreFrontend.value.id)
  toast.success('å·²é‡å¯')
}
```

## ğŸš¢ éƒ¨ç½²æµç¨‹

### å¼€å‘ç¯å¢ƒï¼ˆæ¨èï¼‰
```bash
# ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡
npm start
```

åç«¯å’Œå‰ç«¯éƒ½ä¼šè‡ªåŠ¨å¯åŠ¨ï¼š
- åç«¯ API: `localhost:3000`
- å‰ç«¯ dev server: `localhost:5173` (å¸¦çƒ­æ›´æ–°)

### ç”Ÿäº§ç¯å¢ƒ
```bash
# å¯åŠ¨ç”Ÿäº§æ¨¡å¼ï¼ˆåç«¯ä¼šè‡ªåŠ¨æ„å»ºå‰ç«¯ï¼‰
npm run start:prod
```

è®¿é—®ï¼š`http://<your-ip>:5173`

### ä½¿ç”¨ PM2ï¼ˆæ¨èç”Ÿäº§éƒ¨ç½²ï¼‰
```bash
# å®‰è£… PM2
npm install -g pm2

# å¼€å‘æ¨¡å¼
pm2 start npm --name spages-dev -- start

# ç”Ÿäº§æ¨¡å¼
pm2 start npm --name spages-prod -- run start:prod

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs spages-dev
# æˆ–
pm2 logs spages-prod

# åœæ­¢
pm2 stop spages-dev
pm2 delete spages-dev
```

**è¯´æ˜**ï¼š
- æ— éœ€æ‰‹åŠ¨è¿è¡Œ `npm run build`
- ç”Ÿäº§æ¨¡å¼ä¸‹åç«¯ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶æ„å»ºå‰ç«¯
- æ‰€æœ‰æ„å»ºå’Œå¯åŠ¨è¿‡ç¨‹éƒ½æ˜¯è‡ªåŠ¨åŒ–çš„

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ”¹é€ å®Œæˆæ€»ç»“](.ai/æ”¹é€ å®Œæˆæ€»ç»“.md)
- [å‰ç«¯æ‰˜ç®¡ä¸æ¨¡å¼ç»Ÿä¸€æ”¹é€ è®¡åˆ’](.ai/å‰ç«¯æ‰˜ç®¡ä¸æ¨¡å¼ç»Ÿä¸€æ”¹é€ è®¡åˆ’.md)
- [é¡¹ç›® README](../README.md)

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

1. **æµ‹è¯•æ‰€æœ‰åŠŸèƒ½**ï¼šæ¨¡å¼åˆ‡æ¢ã€å¯åœã€çŠ¶æ€åŒæ­¥
2. **é…ç½®åå‘ä»£ç†**ï¼šNginx/Caddy ç”¨äºç”Ÿäº§ç¯å¢ƒ
3. **è®¾ç½®ç›‘æ§**ï¼šé¡¹ç›®è¿è¡ŒçŠ¶æ€ã€é”™è¯¯æ—¥å¿—
4. **ä¼˜åŒ–æ„å»º**ï¼šåˆ†æåŒ…å¤§å°ï¼Œä¼˜åŒ–åŠ è½½é€Ÿåº¦
5. **è‡ªåŠ¨åŒ–éƒ¨ç½²**ï¼šCI/CD æµç¨‹é›†æˆ

## âœ… æ£€æŸ¥æ¸…å•

å¯åŠ¨éªŒè¯ï¼š
- [ ] åç«¯æˆåŠŸå¯åŠ¨åœ¨ `localhost:3000`
- [ ] å¥åº·æ£€æŸ¥ `/api/health` è¿”å› OK
- [ ] ç³»ç»Ÿå‰ç«¯é¡¹ç›®å‡ºç°åœ¨ `/api/projects` åˆ—è¡¨ä¸­
- [ ] å‰ç«¯ dev server å¯è®¿é—®
- [ ] Dashboard æ˜¾ç¤ºç³»ç»Ÿå‰ç«¯å¡ç‰‡
- [ ] æ¨¡å¼åˆ‡æ¢åŠŸèƒ½æ­£å¸¸
- [ ] SSE çŠ¶æ€å®æ—¶æ›´æ–°

---
**æœ€åæ›´æ–°**ï¼š2025-01-14  
**çŠ¶æ€**ï¼šâœ… æ”¹é€ å®Œæˆï¼Œç³»ç»Ÿæ­£å¸¸è¿è¡Œ
