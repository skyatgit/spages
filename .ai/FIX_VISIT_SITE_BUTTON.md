# ä¿®å¤ï¼šè®¿é—®ç«™ç‚¹æŒ‰é’®é—®é¢˜

## ğŸ› é—®é¢˜æè¿°

### é—®é¢˜ 1ï¼šåœæ­¢åè®¿é—®ç«™ç‚¹æŒ‰é’®æ¶ˆå¤±ï¼Œå¯åŠ¨åä¸å›æ¥

**ç°è±¡ï¼š**
- ç‚¹å‡»"åœæ­¢"æŒ‰é’®åï¼Œè®¿é—®ç«™ç‚¹æŒ‰é’®æ¶ˆå¤± âœ“ï¼ˆæ­£å¸¸ï¼‰
- ç‚¹å‡»"å¯åŠ¨"æŒ‰é’®åï¼Œè®¿é—®ç«™ç‚¹æŒ‰é’®ä¸å›æ¥ âœ—ï¼ˆbugï¼‰

**åŸå› ï¼š**
- è®¿é—®ç«™ç‚¹æŒ‰é’®æ˜¾ç¤ºæ¡ä»¶ï¼š`v-if="project.url"`
- `stopServerV3()` æ­£ç¡®è®¾ç½®äº† `url: null`
- `startServerV3()` **æ²¡æœ‰è®¾ç½® `url`**ï¼Œå¯¼è‡´æŒ‰é’®ä¸æ˜¾ç¤º

### é—®é¢˜ 2ï¼šè®¿é—®ç«™ç‚¹è·³è½¬åˆ° localhost

**ç°è±¡ï¼š**
- è®¿é—®ç«™ç‚¹æŒ‰é’®è·³è½¬åˆ° `http://localhost:3001`
- åœ¨å…¶ä»–è®¾å¤‡ä¸Šæ— æ³•è®¿é—®

**åŸå› ï¼š**
- URL ç¡¬ç¼–ç ä¸º `http://localhost:${port}`
- åº”è¯¥ä½¿ç”¨æœ¬æœº IP åœ°å€ï¼ˆå¦‚ `192.168.1.100`ï¼‰

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. æ·»åŠ è·å–æœ¬æœº IP çš„å‡½æ•°

åœ¨ `server/services/deployment-v3.js` ä¸­æ·»åŠ ï¼š

```javascript
/**
 * è·å–æœ¬æœº IP åœ°å€ï¼ˆä¼˜å…ˆè·å–å±€åŸŸç½‘ IPï¼‰
 */
function getLocalIpAddress() {
  const interfaces = os.networkInterfaces()
  
  // ä¼˜å…ˆæŸ¥æ‰¾å±€åŸŸç½‘ IPv4 åœ°å€
  for (const name of Object.keys(interfaces)) {
    for (const iface of interfaces[name]) {
      // è·³è¿‡å†…éƒ¨åœ°å€å’Œ IPv6
      if (iface.family === 'IPv4' && !iface.internal) {
        return iface.address
      }
    }
  }
  
  // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¿”å› localhost
  return 'localhost'
}
```

**åŠŸèƒ½ï¼š**
- éå†æ‰€æœ‰ç½‘ç»œæ¥å£
- æŸ¥æ‰¾éå†…éƒ¨çš„ IPv4 åœ°å€ï¼ˆå±€åŸŸç½‘ IPï¼‰
- ä¼˜å…ˆè¿”å›å±€åŸŸç½‘ IPï¼ˆå¦‚ 192.168.1.100ï¼‰
- å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¿”å› localhost

### 2. ä¿®å¤ `startServerV3()` - æ·»åŠ çŠ¶æ€æ›´æ–°å’Œå¹¿æ’­

**ä¿®æ”¹å‰ï¼š**
```javascript
await startStaticServer(project, distPath, logger)
console.log(`[startServerV3] Server started successfully on port ${project.port}`)
return { success: true, message: 'Server started successfully' }
```

**ä¿®æ”¹åï¼š**
```javascript
await startStaticServer(project, distPath, logger)
console.log(`[startServerV3] Server started successfully on port ${project.port}`)

// è·å–æœ¬æœº IP
const localIp = getLocalIpAddress()
const url = `http://${localIp}:${project.port}`

// æ›´æ–°é¡¹ç›®çŠ¶æ€å¹¶å¹¿æ’­
updateAndBroadcastProjectState(projectId, {
  status: 'running',
  url: url
})

console.log(`[startServerV3] Project accessible at: ${url}`)

return { success: true, message: 'Server started successfully', url }
```

**æ”¹è¿›ï¼š**
- âœ… è·å–æœ¬æœº IP åœ°å€
- âœ… è®¾ç½® `url` å­—æ®µ
- âœ… å¹¿æ’­çŠ¶æ€å˜åŒ–ï¼ˆé€šè¿‡ SSE å®æ—¶æ›´æ–°å‰ç«¯ï¼‰
- âœ… æ—¥å¿—è¾“å‡ºè®¿é—®åœ°å€

### 3. ä¿®å¤éƒ¨ç½²å®Œæˆæ—¶çš„ URL

**ä¿®æ”¹å‰ï¼š**
```javascript
updateAndBroadcastProjectState(projectId, {
  status: 'running',
  lastDeploy: new Date().toISOString(),
  url: `http://localhost:${project.port}`,  // âŒ localhost
  nodeVersion
})
```

**ä¿®æ”¹åï¼š**
```javascript
const localIp = getLocalIpAddress()
const url = `http://${localIp}:${project.port}`

updateAndBroadcastProjectState(projectId, {
  status: 'running',
  lastDeploy: new Date().toISOString(),
  url: url,  // âœ… æœ¬æœº IP
  nodeVersion
})
```

## ğŸ¯ å·¥ä½œæµç¨‹ï¼ˆä¿®å¤åï¼‰

### å¯åŠ¨é¡¹ç›®

```
ç”¨æˆ·ç‚¹å‡»"å¯åŠ¨"
    â†“
è°ƒç”¨ startServerV3(projectId)
    â†“
å¯åŠ¨é™æ€æœåŠ¡å™¨
    â†“
è·å–æœ¬æœº IPï¼š192.168.1.100
    â†“
è®¾ç½® URLï¼šhttp://192.168.1.100:3001
    â†“
æ›´æ–°çŠ¶æ€å¹¶å¹¿æ’­ SSE äº‹ä»¶
    â†“
å‰ç«¯æ¥æ”¶çŠ¶æ€æ›´æ–°
    â†“
project.url æœ‰å€¼ â†’ æ˜¾ç¤º"è®¿é—®ç«™ç‚¹"æŒ‰é’® âœ…
```

### åœæ­¢é¡¹ç›®

```
ç”¨æˆ·ç‚¹å‡»"åœæ­¢"
    â†“
ï¿½ï¿½ç”¨ stopServerV3(projectId)
    â†“
åœæ­¢é™æ€æœåŠ¡å™¨
    â†“
è®¾ç½® URLï¼šnull
    â†“
æ›´æ–°çŠ¶æ€å¹¶å¹¿æ’­ SSE äº‹ä»¶
    â†“
å‰ç«¯æ¥æ”¶çŠ¶æ€æ›´æ–°
    â†“
project.url ä¸º null â†’ éšè—"è®¿é—®ç«™ç‚¹"æŒ‰é’® âœ…
```

### éƒ¨ç½²é¡¹ç›®

```
éƒ¨ç½²å®Œæˆ
    â†“
è·å–æœ¬æœº IPï¼š192.168.1.100
    â†“
è®¾ç½® URLï¼šhttp://192.168.1.100:3001
    â†“
å¹¿æ’­çŠ¶æ€æ›´æ–°
    â†“
å‰ç«¯æ˜¾ç¤º"è®¿é—®ç«™ç‚¹"æŒ‰é’®ï¼ˆä½¿ç”¨æœ¬æœº IPï¼‰âœ…
```

## ğŸ“Š ä¿®å¤æ•ˆæœ

### é—®é¢˜ 1ï¼šè®¿é—®ç«™ç‚¹æŒ‰é’®æ˜¾ç¤º

| æ“ä½œ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| åœæ­¢é¡¹ç›® | æŒ‰é’®æ¶ˆå¤± âœ“ | æŒ‰é’®æ¶ˆå¤± âœ“ |
| å¯åŠ¨é¡¹ç›® | æŒ‰é’®ä¸å›æ¥ âœ— | æŒ‰é’®æ˜¾ç¤º âœ… |
| éƒ¨ç½²é¡¹ç›® | æŒ‰é’®æ˜¾ç¤º âœ“ | æŒ‰é’®æ˜¾ç¤º âœ… |

### é—®é¢˜ 2ï¼šURL åœ°å€

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| æœ¬æœºè®¿é—® | http://localhost:3001 | http://192.168.1.100:3001 |
| å±€åŸŸç½‘è®¿é—® | âœ— æ— æ³•è®¿é—® | âœ… å¯ä»¥è®¿é—® |
| æ‰‹æœºè®¿é—® | âœ— æ— æ³•è®¿é—® | âœ… å¯ä»¥è®¿é—® |

## ğŸŒ IP åœ°å€ä¼˜å…ˆçº§

`getLocalIpAddress()` çš„æŸ¥æ‰¾é¡ºåºï¼š

1. **ä¼˜å…ˆ**ï¼šéå†…éƒ¨çš„ IPv4 åœ°å€ï¼ˆå±€åŸŸç½‘ IPï¼‰
   - ä¾‹å¦‚ï¼š192.168.1.100ã€10.0.0.5ã€172.16.0.10
2. **å¤‡é€‰**ï¼šlocalhostï¼ˆå¦‚æœæ²¡æœ‰æ‰¾åˆ°å±€åŸŸç½‘ IPï¼‰

**ç¤ºä¾‹ï¼š**

```
ç½‘ç»œæ¥å£åˆ—è¡¨ï¼š
- lo (å†…éƒ¨): 127.0.0.1 â†’ è·³è¿‡ï¼ˆinternalï¼‰
- eth0: 192.168.1.100 â†’ âœ… è¿”å›è¿™ä¸ª
- wlan0: 10.0.0.5 â†’ ä¸æ£€æŸ¥ï¼ˆå·²æ‰¾åˆ°ï¼‰
```

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šåœæ­¢åå¯åŠ¨

**æ­¥éª¤ï¼š**
1. é¡¹ç›®æ­£åœ¨è¿è¡Œï¼Œè®¿é—®ç«™ç‚¹æŒ‰é’®æ˜¾ç¤º
2. ç‚¹å‡»"åœæ­¢"
3. ç‚¹å‡»"å¯åŠ¨"

**é¢„æœŸç»“æœï¼š**
- âœ… åœæ­¢åæŒ‰é’®æ¶ˆå¤±
- âœ… å¯åŠ¨åæŒ‰é’®ç«‹å³æ˜¾ç¤º
- âœ… æŒ‰é’® URL ä½¿ç”¨æœ¬æœº IP

### åœºæ™¯ 2ï¼šå±€åŸŸç½‘è®¿é—®

**æ­¥éª¤ï¼š**
1. éƒ¨ç½²æˆ–å¯åŠ¨é¡¹ç›®
2. ç‚¹å‡»"è®¿é—®ç«™ç‚¹"
3. å¤åˆ¶ URL åˆ°æ‰‹æœºæµè§ˆå™¨

**é¢„æœŸç»“æœï¼š**
- âœ… URL ä¸º `http://192.168.x.x:port`
- âœ… æ‰‹æœºèƒ½æˆåŠŸè®¿é—®

### åœºæ™¯ 3ï¼šéƒ¨ç½²æ–°é¡¹ç›®

**æ­¥éª¤ï¼š**
1. æ·»åŠ æ–°é¡¹ç›®å¹¶éƒ¨ç½²
2. éƒ¨ç½²å®ŒæˆåæŸ¥çœ‹è®¿é—®ç«™ç‚¹æŒ‰é’®

**é¢„æœŸç»“æœï¼š**
- âœ… æŒ‰é’®æ˜¾ç¤º
- âœ… URL ä½¿ç”¨æœ¬æœº IP

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### å‰ç«¯æŒ‰é’®æ˜¾ç¤ºé€»è¾‘

```vue
<a v-if="project.url" :href="project.url" target="_blank" class="btn btn-secondary">
  ğŸ”— {{ $t('projectDetail.visitSite') }}
</a>
```

**æ˜¾ç¤ºæ¡ä»¶ï¼š** `project.url` æœ‰å€¼ä¸”ä¸ä¸º null

### SSE å®æ—¶æ›´æ–°

```
åç«¯æ›´æ–°çŠ¶æ€
    â†“
updateAndBroadcastProjectState(projectId, { url })
    â†“
SSE å¹¿æ’­äº‹ä»¶
    â†“
å‰ç«¯æ¥æ”¶å¹¶æ›´æ–° project.value
    â†“
Vue å“åº”å¼æ›´æ–° UI
```

### ç½‘ç»œæ¥å£ç¤ºä¾‹

```javascript
{
  'lo': [
    { address: '127.0.0.1', family: 'IPv4', internal: true }
  ],
  'eth0': [
    { address: '192.168.1.100', family: 'IPv4', internal: false },
    { address: 'fe80::1', family: 'IPv6', internal: false }
  ],
  'wlan0': [
    { address: '10.0.0.5', family: 'IPv4', internal: false }
  ]
}
```

## ğŸ‰ ä¿®å¤æ€»ç»“

### ä¿®æ”¹çš„æ–‡ä»¶

1. **`server/services/deployment-v3.js`**
   - âœ… æ·»åŠ  `getLocalIpAddress()` å‡½æ•°
   - âœ… ä¿®å¤ `startServerV3()` - æ·»åŠ çŠ¶æ€æ›´æ–°å’Œå¹¿æ’­
   - âœ… ä¿®å¤éƒ¨ç½²å®Œæˆæ—¶çš„ URLï¼ˆä½¿ç”¨æœ¬æœº IPï¼‰

### è§£å†³çš„é—®é¢˜

1. âœ… **åœæ­¢åå¯åŠ¨ï¼Œè®¿é—®ç«™ç‚¹æŒ‰é’®å›æ¥äº†**
   - é€šè¿‡åœ¨ `startServerV3()` ä¸­è®¾ç½® `url` å’Œå¹¿æ’­çŠ¶æ€

2. âœ… **è®¿é—®ç«™ç‚¹ä½¿ç”¨æœ¬æœº IP è€Œä¸æ˜¯ localhost**
   - é€šè¿‡ `getLocalIpAddress()` è·å–å±€åŸŸç½‘ IP
   - å±€åŸŸç½‘å…¶ä»–è®¾å¤‡å¯ä»¥è®¿é—®

### é¢å¤–ä¼˜åŠ¿

- âœ… **ç§»åŠ¨è®¾å¤‡å¯ä»¥è®¿é—®** - ä½¿ç”¨å±€åŸŸç½‘ IP
- âœ… **å®æ—¶æ›´æ–°** - é€šè¿‡ SSE ç«‹å³æ˜¾ç¤ºæŒ‰é’®
- âœ… **è‡ªåŠ¨æ£€æµ‹** - è‡ªåŠ¨æ‰¾åˆ°æœ€åˆé€‚çš„ç½‘ç»œæ¥å£
- âœ… **å…¼å®¹æ€§å¥½** - æ‰¾ä¸åˆ° IP æ—¶é™çº§åˆ° localhost

---

**ä¿®å¤æ—¥æœŸï¼š** 2025-11-12  
**çŠ¶æ€ï¼š** âœ… å·²å®Œæˆ  
**å½±å“ï¼š** è®¿é—®ç«™ç‚¹æŒ‰é’®æ­£å¸¸æ˜¾ç¤ºï¼Œä½¿ç”¨æœ¬æœº IP åœ°å€

