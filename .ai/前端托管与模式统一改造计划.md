# 前端托管与模式统一改造计划（Dev/Prod 双模式，后端受管）

## 1. 目标与范围
### 1.1 总目标
将当前本项目的前端（SPages 自身 UI）纳入后端统一管理体系：
- 后端永久只监听 `localhost`（API 不直接对外暴露）。
- 对外仅暴露“前端服务层”（静态托管或 Dev Server）。
- 前端作为一个“系统级受管项目”，统一启停、端口、状态、日志、部署历史管理。
- 支持两种模式：
  - 开发模式（dev）：使用 Vite dev server（热更新）。
  - 生产模式（prod）：使用构建后的静态产物（内置静态文件服务器托管 `dist/`）。

### 1.2 不在本次范围（暂不做）
- SSR 框架运行（Next/Nuxt 原生运行线程）。
- 多实例前端负载均衡。
- HTTPS 证书自动配置。
- WebSocket/BroadcastChannel 替换 SSE。

## 2. 当前架构与存在问题
### 2.1 当前状态
| 组件 | 启动方式 | 对外暴露 | 管理方式 |
|------|----------|----------|----------|
| 后端 Express | `node server/index.js` | 可能暴露到外部（生产时静态托管前端） | 无统一进程索引（仅自身） |
| 当前前端 | 开发: Vite `npm run dev` / 生产: dist 由 express 静态托管 | 直接/内嵌 | 不在项目列表中（无法通过项目管理面板控制） |
| 其它 GitHub 项目 | deploy → build → 内置 http 静态托管 | 暴露端口/IP | 有状态 / 日志 / 部署历史 |

### 2.2 问题
- 前端未纳入“项目管理”体系：无法在 UI 中统一查看/重启。
- 生产静态托管耦合在 `server/index.js`，不符合“后端仅 localhost”设计。
- 无 dev/prod 模式切换控制逻辑。
- 端口冲突时不自动回退或提示。
- 前端运行状态与 API 同进程，后续扩展不灵活（如独立重启、限流、维护页）。

## 3. 目标架构（改造后）
```
浏览器
  ↓
访问 http://<绑定域名或IP>:<前端端口>
  ↓
前端服务进程（受管：dev 模式或静态托管模式）
  ↓       （内部 API 请求）
localhost:3000 后端 Express（只接受来自本机或前端代理请求）
```

### 3.1 系统前端项目描述（示例）
```jsonc
{
  "id": "proj_spages_frontend",        // 固定ID
  "name": "spages-frontend",           // 项目名称
  "type": "core",                      // 标记系统级项目
  "mode": "dev" | "prod",             // 当前运行模式
  "port": 5173,                         // 前端监听端口（dev或静态）
  "outputDir": "dist",                 // 构建产物���录
  "framework": "vue",                  // 基本标识
  "managed": true,                      // 受管标记
  "status": "running|stopped|building|failed", // 运行状态
  "lastDeploy": "ISO时间戳",            // 最近一次构建/模式切换时间
  "url": "http://<ip>:<port>",
  "updatedAt": "ISO时间戳"
}
```

## 4. 数据与配置改造
### 4.1 新增/扩展文件
| 文件 | 改动类型 | 内容 |
|------|----------|------|
| `data/config.json` | 扩展 | 增加 `frontend` 节点：`{ projectId, defaultMode, defaultPort, autoRestart }` |
| `data/projects-index.json` | 初始化插入 | 自动插入系统前端项目索引（若不存在） |
| `projects/spages-frontend/.spages/config.json` | 新建或映射 | 前端项目配置（可选择映射实际根目录） |

### 4.2 配置字段说明
```jsonc
{
  "frontend": {
    "projectId": "proj_spages_frontend",
    "defaultMode": "dev",            // 初始化默认模式
    "defaultPort": 5173,
    "autoRestart": true               // 探测异常自动重启（可选后续实现）
  }
}
```

### 4.3 索引管理逻辑
- 系统启动时执行：
  1. 读取 `projects-index.json`，检查是否存在 `proj_spages_frontend`。
  2. 不存在则创建：写入基础配置、生成 `.spages` 目录结构。
  3. 若存在但字段缺失（如 mode），补齐默认值。

## 5. 后端代码改造点
### 5.1 核心改动列表
| 模块 | 改动内容 |
|------|----------|
| `server/index.js` | 去除生产模式 express.static，增加“初始化系统前端项目并按模式启动”逻辑 |
| `services/project-manager.js` | 支持“核心项目”root路径自定义（不强制 projects/ 下）或创建一个镜像目录 |
| `services/deployment-v3.js` | 部署逻辑：为核心前端项目跳过 clone；构建/启动分支处理 dev/prod 模式；新增切换模式函数 |
| `services/node-manager.js` | 启动 dev server（`npm run dev`）子进程支持（现有只用于静态构建命令，需要新增长驻进程管理） |
| `routes/projects-v3.js` | 新增 API：`POST /api/projects/:id/mode`（切换 dev/prod） |
| `SSE 广播` | 补充 mode 字段到状态广播 |

### 5.2 新增函数（示例）
- `startFrontendDev(project)`：启动 `npm run dev`，监听日志流，提取端口（冲突处理）。
- `startFrontendStatic(project)`：已有静态托管方式复用。
- `switchProjectMode(projectId, targetMode)`：
  1. stop → 判断 targetMode → dev: 启动 dev；prod: 执行 build + static Serve。
  2. 更新配置 + SSE 广播。

### 5.3 端口冲突策略
伪代码：
```js
async function findAvailablePort(preferred) {
  for (let p = preferred; p < preferred + 20; p++) {
    if (await isFree(p)) return p
  }
  throw new Error('No free port found in range')
}
```
`isFree(port)`：创建临时 server.listen(port) → 成功即 free → close。

### 5.4 Dev Server 子进程管理
- 使用 `child_process.spawn('npm', ['run', 'dev'], { cwd })`。
- 捕获 stdout/stderr：
  - 分析端口：匹配如 `Local: *http://localhost:(\d+)`。
  - 推送日志到 SSE（统一格式）。
- 关闭：child.kill('SIGTERM')；若超时未退出 → 强制 `SIGKILL`。
- 防止僵尸进程：监听 `exit` 事件，清理运行映射。

### 5.5 健康检查与自动重启（可选）
- 静态模式：定时请求 `http://localhost:<port>/index.html` → 非 200 连续 N 次 → 标记 failed → 若 autoRestart 尝试重新部署。
- Dev 模式：定时请求 `http://localhost:<port>/` → 若端口不可达 → 标记 failed。

## 6. 前端 UI 改造
### 6.1 新增系统前端项目展示
在项目列表中：
- 插入一个“系统前端”卡片（可锁定置顶）。
- 显示：模式（dev/prod）、端口、打开站点、切换模式按钮、重启按钮、日志查看。

### 6.2 模式切换交互
操作：
1. 点击“切换为生产模式” → 弹出确认（提示将执行构建）。
2. SSE 推送状态：`building` → `running`。
3. 切换完成后按钮文案变为“切换为开发模式”。

### 6.3 失败状态显示
- 若 `status = failed`：显示重试部署按钮 + 错误信息（从最新日志截取错误行）。

## 7. API 设计
| API | 方法 | 描述 | 请求体 | 响应 |
|-----|------|------|--------|------|
| `/api/projects/:id/mode` | POST | 切换模式 | `{ mode: "dev"|"prod" }` | `{ success, mode, port, url }` |
| `/api/projects/:id/restart` | POST | 重启当前模式 | - | `{ success }` |
| `/api/projects/:id/logs` | GET | 获取日志 | 可选 `?deploymentId=` | 日志数组 |
| `/api/projects/:id/state` | GET | 当前状态 | - | `{ id, mode, status, port, url, nodeVersion }` |

SSE 扩展：
```jsonc
{
  "type": "project.update",
  "projectId": "proj_spages_frontend",
  "data": {
    "mode": "dev",
    "status": "running",
    "port": 5173,
    "url": "http://192.168.1.100:5173"
  }
}
```

## 8. 改造阶段计划（里程碑）
| 阶段 | 目标 | 产出 | 预计工时 |
|------|------|------|---------|
| M1 初始化 | 核心项目索引写入，删除生产静态托管耦合 | 能识别系统前端项目 | 0.5d |
| M2 Dev 模式 | 可启动/停止 Vite dev，SSE 状态正确 | dev 可访问，日志实时 | 1d |
| M3 Prod 模式 | 构建 + 静态托管；切换模式 API | 前端可在 prod 模式运行 | 1d |
| M4 UI 集成 | 前端卡片、模式切换、日志面板 | 管理界面完整 | 1d |
| M5 健康与自动重启（可选） | 定时检测失败重启 | 稳定性提升 | 0.5d |
| M6 整体测试与文档 | 测试脚本 & 使用说明 | 交付文档 & 通过测试 | 0.5d |

## 9. 回滚策略
| 情况 | 触发条件 | 回滚操作 |
|------|----------|----------|
| Dev 模式无法启动 | 端口冲突 / 启动超时 | 自动换端口 → 若仍失败：回滚到 prod 模式静态 |
| Prod 构建失败 | npm run build exit code ≠0 | 标记 failed → 保留旧 dist（若存在） → 允许重试 |
| SSE 广播异常 | 无法推送/内存泄漏 | 清理订阅 Map，重建连接 |
| 内置静态服务异常 | 端口占用或访问失败 | 换端口重启 → 仍失败则标记 failed |

## 10. 风险与缓解
| 风险 | 描述 | 缓解 |
|------|------|------|
| 端口被占用 | 用户配置固定端口被其它进程使用 | 自动探测空闲端口 + 提示真实端口 |
| Dev 进程僵尸 | kill 不彻底残留子进程 | 加 `exit` 监听 + 超时强杀 |
| 构建耗时长 | 大型项目构建阻塞其它操作 | 后台任务 + 状态提示 + 进度日志 |
| 日志过大 | 多次构建日志堆积 | 保留最近 N（如 20）次部署日志，定期清理 |
| 写入索引失败 | 初次创建或更新失败 | 重试+写入锁+错误回滚（不破坏原 index） |
| 文件路径混淆 | 系统前端项目 root 与普通项目处理差异 | 在 ProjectPaths 增加 isCore 标记，分支处理 |

## 11. 测试用例设计
### 11.1 单元测试（后端，可选）
- `findAvailablePort()`：给定已占用端口 → 返回下一个可用。
- `switchProjectMode()`：dev→prod / prod→dev 状态和日志正确。

### 11.2 集成测试流程
1. 启动后端（无系统前端索引） → 自动插入系统前端项目。
2. 切换到 dev 模式 → 访问页面 → SSE 状态为 running。
3. 切换到 prod 模式 → 构建成功 → 访问页面返回静态 index.html。
4. 模拟端口冲突（占用 5173）→ 启动 dev 模式 → 自动改到 5174。
5. 构建失败（手动破坏 package.json）→ prod 切换 → 状态 failed。
6. 重启按钮在不同模式下行为正确。

### 11.3 人工验证清单
- 日志实时刷新。
- 切换模式后 URL 和端口更新。
- 后端 API 不可通过外部直接访问（限制到 localhost）。
- 失败状态可恢复（重试部署）。

## 12. 监控与可观察性（后续增强）
| 项目 | 指标 | 实现思路 |
|------|------|----------|
| 前端服务可用性 | uptime / lastFailure | 定时探测 + 记录次数 |
| 构建性能 | buildDuration | deployProjectV3 记录 start/end 时间 |
| 重启次数 | restartCount | mode 切换与自动重启处自增 |
| 错误日志 | errorLogCount | 解析日志类型为 error 数量 |

## 13. 未来扩展建议
- 支持 SSR 项目模式（startCommand 与反向代理接入）。
- 加入“维护模式”标志（前端显示维护页，API 正常）。
- Graceful 资产预热（构建完成后预读关键文件到内存）。
- HTTPS 支持（在 proxy-server 中加入证书配置）。
- 前端资源指纹校验与缓存失效策略控制。

## 14. 实施优先级建议
1. 先改后端索引 & 启动逻辑（最少改动验证闭环）。
2. 接入 dev/prod 模式切换控制。
3. 替换生产静态托管为“系统前端项目”托管。
4. 增加端口探测与日志 UI。
5. 健康检查与自动重启（如仍有需求）。

## 15. 交付产物清单
| 类别 | 产物 |
|------|------|
| 代码 | 新/修改的服务、路由、数据结构实现 |
| 文档 | 此改造计划 + 使用说明 + 回滚指南 |
| 配置 | 更新后的 `data/config.json` & `projects-index.json` |
| 测试 | 基础集成验证脚本（可选） |

## 16. 准备与依赖检查
- 需要确认 package.json 中存在 `dev` 与 `build` 脚本。
- 确认现有项目的 SSE、部署广播无冲突字段（添加 `mode` 不影响前端解析）。
- 确认删除/禁用当前生产模式下 express.static 部分不会影响其它功能。

## 17. 执行步骤骨架（伪代码）
```js
// initSystemFrontend.js
function ensureSystemFrontend() {
  const index = loadProjectsIndex()
  if (!index['proj_spages_frontend']) {
    index['proj_spages_frontend'] = createDefaultFrontendEntry()
    saveProjectsIndex(index)
    createProjectStructure('spages-frontend')
  }
}

// server/index.js
await initApp()
ensureSystemFrontend()
const cfg = loadFrontendConfig()
if (cfg.mode === 'dev') startFrontendDev(cfg) else startFrontendStatic(cfg)
```

## 18. 审核清单（上线前）
| 项 | 是否完成 |
|----|----------|
| 自动插入系统前端索引 |  |
| 切换模式 API |  |
| dev 启动/停止逻辑 |  |
| prod 构建 + 静态托管 |  |
| SSE 增加 mode 字段 |  |
| UI 显示模式与端口 |  |
| express 静态托管移除或条件化 |  |
| 端口冲突测试用例通过 |  |
| 构建失败回滚策略测试 |  |
| 日志截断策略确认 |  |
| 回滚说明文档 |  |

## 19. 回滚指引（快速）
1. 停止系统前端项目运行（`stopServerV3('proj_spages_frontend')`）。
2. 恢复 `server/index.js` 中原生产模式 `express.static(dist)`。
3. 删除项目索引中的 `proj_spages_frontend` 条目。
4. 清理临时构建目录或子进程。

---
**最后说明**：此计划在保证最小侵入的同时，实现本项目前端受管、模式可切换、运行边界清晰。若你确认没有遗漏可直接进入 M1 阶段（索引与启动逻辑）实施。需要补充内容随时提出。
